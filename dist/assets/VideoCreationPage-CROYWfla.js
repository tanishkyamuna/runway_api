var R=Object.defineProperty;var I=(d,t,e)=>t in d?R(d,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[t]=e;var k=(d,t,e)=>I(d,typeof t!="symbol"?t+"":t,e);import{s as g,j as r}from"./index-CZWYOJc5.js";import{u as T,e as $,r as v}from"./vendor-C93i42Td.js";import{k as w,g as S,j as U,W as A,f as D,p as L}from"./ui-DKXepuIc.js";class M{constructor(){this.DEFAULT_MAX_RETRIES=3,this.DEFAULT_TIMEOUT=3e4}async withRetries(t,e={}){const{maxRetries:s=this.DEFAULT_MAX_RETRIES,timeout:a=this.DEFAULT_TIMEOUT,retryableErrors:o=["FunctionsFetchError","TypeError","FetchError"],onRetry:i=null}=e;let u;for(let n=1;n<=s;n++)try{return await Promise.race([t(n),new Promise((f,c)=>setTimeout(()=>c(new Error("Request timeout")),a))])}catch(l){if(u=l,console.error(`Attempt ${n} failed:`,{attempt:n,error:{message:l.message,name:l.name,stack:l.stack}}),this._shouldRetry(l,n,s,o)){i&&await i(n,l),await this._wait(n);continue}break}throw this._enhanceError(u,s)}_shouldRetry(t,e,s,a){return e>=s?!1:a.includes(t.name)||t.message==="Request timeout"||t.message.includes("network")||t.message.includes("Failed to fetch")?!0:t.status?[408,429,500,502,503,504].includes(t.status):!1}async _wait(t){const e=Math.min(1e3*Math.pow(2,t-1),1e4),s=Math.random()*1e3;await new Promise(a=>setTimeout(a,e+s))}_enhanceError(t,e){return t?(t.retriesExhausted=!0,t.maxRetries=e,t.name==="FunctionsFetchError"&&(t.message="Failed to connect to video service after multiple attempts. Please try again later."),t):new Error("Operation failed after retries")}}const O=new M,E=class E{async createVideo(t,e){try{if(!t)throw new Error("Image URL is required");if(!(e!=null&&e.id))throw new Error("Template ID is required");const{data:{user:s},error:a}=await g.auth.getUser();if(a)throw new Error(`Authentication error: ${a.message}`);if(!s)throw new Error("Please sign in to create videos");const{data:o,error:i}=await g.from("videos").insert({user_id:s.id,template_id:e.id,image_path:t,status:"pending"}).select().single();if(i)throw console.error("Video creation error:",i),new Error(`Failed to create video record: ${i.message}`);const{error:u}=await g.from("video_generations").insert({video_id:o.id,status:"pending",progress:0});if(u)throw console.error("Generation record error:",u),new Error(`Failed to create generation record: ${u.message}`);const n=e.orientation==="portrait"?"9:16":"16:9",l=await O.withRetries(async c=>{console.log(`Attempt ${c} to call webhook`);const m=await fetch(E.MAKE_WEBHOOK_URL,{method:"POST",headers:{"Content-Type":"application/json",Accept:"text/plain"},body:JSON.stringify({videoId:o.id,userId:s.id,imageUrl:t,templateId:e.id,template:{id:e.id,title:e.title,prompt:e.prompt||`Create a cinematic property video showcasing ${e.title}`,style:e.style||"cinematic",duration:e.duration||10,aspectRatio:n},callbacks:{success:"https://lbajcpgmohirgxmecdmd.supabase.co/functions/v1/video-complete",error:"https://lbajcpgmohirgxmecdmd.supabase.co/functions/v1/video-error"}})});if(!m.ok){const j=await m.text();throw new Error(`Make.com webhook failed: ${m.status} ${m.statusText}. Response: ${j}`)}const y=await m.text();if(y.toLowerCase()!=="accepted")throw new Error(`Unexpected response from Make.com: ${y}`);return{success:!0}},{maxRetries:3,timeout:3e4,onRetry:(c,m)=>{console.warn(`Retry ${c} due to error:`,m),w.error(`Retrying video creation (${c}/3)...`)}}),{error:f}=await g.from("videos").update({status:"processing",updated_at:new Date().toISOString()}).eq("id",o.id);return f&&console.error("Error updating video status:",f),{success:!0,videoId:o.id}}catch(s){console.error("Error creating video:",s);let a="Failed to create video. ";throw s.message.includes("Authentication")?a+="Please sign in and try again.":s.message.includes("timeout")?a+="The request timed out. Please try again.":s.message.includes("network")?a+="Please check your internet connection.":a+="Please try again later.",w.error(a),s}}};k(E,"MAKE_WEBHOOK_URL","https://hook.eu1.make.com/urhqhs1gwa9j3ykqnnpgmitsvpnkrmdk");let b=E;Object.freeze(b);Object.freeze(b.prototype);const P=new b;Object.freeze(P);class C{constructor(){this.MAX_FILE_SIZE=5*1024*1024,this.ALLOWED_TYPES=["image/jpeg","image/png","image/webp"]}async uploadImage(t,e){try{this._validateFile(t),this._validateUserId(e);const{filePath:s,fileName:a}=this._generateFilePath(t,e),{error:o}=await g.storage.from("images").upload(s,t,{cacheControl:"3600",upsert:!1,contentType:t.type});if(o)throw console.error("Upload error:",o),new Error("Failed to upload image");const{data:{publicUrl:i}}=g.storage.from("images").getPublicUrl(s);if(!i)throw new Error("Failed to get public URL");return{path:s,url:i}}catch(s){throw console.error("Storage service error:",{message:s.message,stack:s.stack,details:s}),s}}_validateFile(t){if(!t)throw new Error("No file provided");if(!this.ALLOWED_TYPES.includes(t.type))throw new Error("Invalid file type. Only JPEG, PNG and WebP images are allowed.");if(t.size>this.MAX_FILE_SIZE)throw new Error("File size must be less than 5MB")}_validateUserId(t){if(!t)throw new Error("User ID is required")}_generateFilePath(t,e){const s=Date.now(),a=Math.random().toString(36).substring(7),o=t.name.split(".").pop(),i=`${s}-${a}.${o}`;return{filePath:`${e}/${i}`,fileName:i}}async downloadVideo(t){try{if(!t)throw new Error("Video path is required");const{data:e,error:s}=await g.storage.from("videos").download(t);if(s)throw console.error("Download error:",s),new Error("Failed to download video");return e}catch(e){throw console.error("Download error:",{message:e.message,stack:e.stack,details:e}),e}}}const q=new C,X=()=>{var N;const d=T(),e=(N=$().state)==null?void 0:N.template,[s,a]=v.useState(null),[o,i]=v.useState(null),[u,n]=v.useState(!1),[l,f]=v.useState(null),[c,m]=v.useState((e==null?void 0:e.defaultDuration)||10);if(!e)return d("/templates"),null;const y=h=>{const p=h.target.files[0];if(!p)return;if(!p.type.startsWith("image/")){w.error("Please select a valid image file");return}if(p.size>5*1024*1024){w.error("Image size must be less than 5MB");return}a(p);const x=new FileReader;x.onloadend=()=>i(x.result),x.readAsDataURL(p)},j=async()=>{if(!s){w.error("Please select an image");return}n(!0),f(null);try{const{data:{user:h}}=await g.auth.getUser();if(!h)throw new Error("Please sign in to create videos");const{data:p,error:x}=await g.from("user_credits").select("free_videos_remaining").eq("user_id",h.id).single();if(x||!p||p.free_videos_remaining<=0)throw new Error("No credits remaining. Please upgrade your plan.");const{url:_}=await q.uploadImage(s,h.id);if(!_)throw new Error("Failed to upload image");if(!(await P.createVideo(_,{...e,duration:c,imageOrientation:e.orientation||"landscape"})).success)throw new Error("Failed to start video creation");const{error:F}=await g.from("user_credits").update({free_videos_remaining:p.free_videos_remaining-1,updated_at:new Date().toISOString()}).eq("user_id",h.id);if(F)throw F;w.success("Video creation started successfully!"),d("/dashboard")}catch(h){console.error("Error creating video:",h),f(h.message||"Failed to create video"),w.error(h.message||"Failed to create video")}finally{n(!1)}};return r.jsx("div",{className:"min-h-screen bg-gray-50 py-12",children:r.jsxs("div",{className:"max-w-4xl mx-auto px-4",children:[r.jsxs("div",{className:"text-center mb-12",children:[r.jsx("h1",{className:"text-4xl font-bold mb-4",children:"Create Your Video"}),r.jsxs("p",{className:"text-xl text-gray-600",children:["Upload your image and we'll transform it using the ",e.title," template"]})]}),r.jsxs("div",{className:"bg-white rounded-lg shadow-lg overflow-hidden",children:[r.jsxs("div",{className:"p-6 border-b",children:[r.jsx("h2",{className:"text-xl font-bold mb-4",children:"Selected Template"}),r.jsxs("div",{className:`relative ${e.orientation==="portrait"?"aspect-[9/16]":"aspect-video"} rounded-lg overflow-hidden`,children:[r.jsx("img",{src:e.image_url,alt:e.title,className:"w-full h-full object-cover"}),r.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/60 to-transparent flex items-end",children:r.jsxs("div",{className:"p-4 text-white",children:[r.jsx("h3",{className:"text-lg font-bold",children:e.title}),r.jsx("p",{className:"text-sm",children:e.description})]})})]})]}),r.jsxs("div",{className:"p-6 border-b",children:[r.jsx("h2",{className:"text-xl font-bold mb-4",children:"Video Duration"}),r.jsxs("div",{className:"flex gap-4",children:[r.jsxs("button",{onClick:()=>m(5),className:`flex-1 py-3 px-4 rounded-lg flex items-center justify-center gap-2 ${c===5?"bg-blue-600 text-white":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:[r.jsx(S,{className:"w-5 h-5"}),"5 Seconds"]}),r.jsxs("button",{onClick:()=>m(10),className:`flex-1 py-3 px-4 rounded-lg flex items-center justify-center gap-2 ${c===10?"bg-blue-600 text-white":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:[r.jsx(S,{className:"w-5 h-5"}),"10 Seconds"]})]})]}),r.jsxs("div",{className:"p-6",children:[r.jsx("h2",{className:"text-xl font-bold mb-4",children:"Upload Your Image"}),r.jsxs("div",{className:"mb-6",children:[r.jsx("input",{type:"file",id:"image-upload",className:"hidden",onChange:y,accept:"image/*"}),r.jsx("label",{htmlFor:"image-upload",className:"cursor-pointer block",children:o?r.jsxs("div",{className:`relative ${e.orientation==="portrait"?"aspect-[9/16]":"aspect-video"}`,children:[r.jsx("img",{src:o,alt:"Preview",className:"w-full h-full object-cover rounded-lg"}),r.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 opacity-0 hover:opacity-100 transition-opacity rounded-lg",children:r.jsx("span",{className:"text-white",children:"Change Image"})})]}):r.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-12 text-center",children:[r.jsx(U,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),r.jsx("p",{className:"text-gray-600",children:"Drop your image here or click to browse"}),r.jsx("p",{className:"text-sm text-gray-500 mt-2",children:e.orientation==="portrait"?"Best with vertical (9:16) images":"Best with landscape (16:9) images"})]})})]}),r.jsxs("button",{onClick:j,disabled:!s||u,className:"relative w-full group",children:[r.jsx("div",{className:"absolute -inset-1 bg-gradient-to-r from-purple-600 to-blue-600 rounded-lg blur opacity-25 group-hover:opacity-100 transition duration-1000 group-hover:duration-200"}),r.jsx("div",{className:"relative w-full px-7 py-6 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg leading-none flex items-center justify-center space-x-3",children:u?r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"}),r.jsx("span",{className:"text-white text-lg font-bold",children:"Creating Magic..."})]}):r.jsxs(r.Fragment,{children:[r.jsx(A,{className:"w-6 h-6 text-white"}),r.jsxs("span",{className:"text-white text-lg font-bold",children:["Create ",c,"-Second Video"]}),r.jsx(D,{className:"w-6 h-6 text-white"})]})})]}),l&&r.jsxs("div",{className:"mt-4 p-4 bg-red-50 text-red-600 rounded-lg flex items-center gap-2",children:[r.jsx(L,{className:"w-5 h-5"}),r.jsx("p",{children:l})]})]})]})]})})};export{X as default};
//# sourceMappingURL=VideoCreationPage-CROYWfla.js.map
